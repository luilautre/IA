<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>IA de luilautre</title>
<script src="https://luilautre.github.io/libs/markdown-it.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding-bottom: 160px; /* espace pour chat flottant */
    color: #333;
    line-height: 1.6;
    background: #f0f2f5;
  }

  /* Blocs Markdown / bulles */
  .md-rendered {
    background: #fff;
    padding: 20px;
    margin: 10px 0;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: transform 0.2s ease;
  }
  .md-rendered:hover { transform: translateY(-1px); }

  /* Bulles IA / User */
  .reply-ia { background: #dce6ff; align-self: flex-start; }
  .reply-user { background: #c9f7dc; align-self: flex-end; }

  h1 { font-size: 2em; color: #1a1a1a; }
  h2 { font-size: 1.6em; color: #222; margin-top: 1em; }
  h3 { font-size: 1.3em; color: #333; margin-top: 1em; }
  pre { background: #f4f4f8; padding: 12px; border-radius: 8px; overflow-x: auto; }
  ul { padding-left: 25px; margin: 10px 0; }

  /* Chat flottant */
  .chat-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #ffffffee;
    padding: 12px 20px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    display: flex;
    gap: 10px;
    align-items: center;
    z-index: 1000;
  }
  .chat-container textarea {
    width: 450px;
    height: 45px;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid #ccc;
    resize: none;
    font-size: 1em;
  }
  .chat-container textarea:focus {
    outline: none;
    border-color: #5b8def;
    box-shadow: 0 0 5px #5b8def33;
  }
  .chat-container button {
    padding: 10px 20px;
    border-radius: 12px;
    border: none;
    background: #5b8def;
    color: white;
    cursor: pointer;
    font-size: 1em;
    transition: background 0.2s, transform 0.1s;
  }
  .chat-container button:hover {
    background: #3f6fd1;
    transform: scale(1.05);
  }

  /* Container des réponses */
  #reply-container {
    display: flex;
    flex-direction: column;
    margin-top: 20px;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    padding-right: 10px;
  }
  #reply-container::-webkit-scrollbar {
    width: 8px;
  }
  #reply-container::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.2);
    border-radius: 4px;
  }
</style>
</head>
<body>

<!-- Chat flottant -->
<div class="chat-container">
  <textarea id="message" placeholder="Écris ton message"></textarea>
  <button id="send">Envoyer</button>
</div>

<!-- Conteneur des réponses -->
<div id="reply-container"></div>

<script>
const md = window.markdownit();
const replyContainer = document.getElementById("reply-container");

// --- Mémoire ---
let sessionHistory = []; // courte (session)
let longTermMemory = JSON.parse(localStorage.getItem("chatMemory") || "[]"); // longue
let customMemory = { userName: "Luilautre", favoriteTopic: "IA et Markdown" };

// --- Message de bienvenue automatique ---
const initialMessage = "Bonjour ! Je suis votre assistant. Comment puis-je vous aider aujourd'hui ?";

// Ajouter à la mémoire courte et longue
sessionHistory.push({ role: "assistant", content: initialMessage });
longTermMemory.push({ role: "assistant", content: initialMessage });
localStorage.setItem("chatMemory", JSON.stringify(longTermMemory));

// Afficher sur la page
const iaDiv = document.createElement("div");
iaDiv.className = "md-rendered reply-ia";
iaDiv.innerHTML = md.render(initialMessage);
replyContainer.appendChild(iaDiv);

// --- Gestion de l'envoi ---
document.getElementById("send").addEventListener("click", async () => {
  const msg = document.getElementById("message").value.trim();
  if (!msg) return;

  // Afficher message utilisateur
  const userDiv = document.createElement("div");
  userDiv.className = "md-rendered reply-user";
  userDiv.textContent = msg;
  replyContainer.appendChild(userDiv);

  // Ajouter à la mémoire courte
  sessionHistory.push({ role: "user", content: msg });

  // Préparer payload pour serveur
  const payload = { message: msg, sessionHistory, longTermMemory, customMemory };

  // Envoyer au serveur
  const res = await fetch("/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  const data = await res.json();

  // Afficher réponse IA
  const iaDiv = document.createElement("div");
  iaDiv.className = "md-rendered reply-ia";
  iaDiv.innerHTML = md.render(data.reply);
  replyContainer.appendChild(iaDiv);

  // Ajouter à la mémoire courte et longue
  sessionHistory.push({ role: "assistant", content: data.reply });
  longTermMemory.push({ role: "assistant", content: data.reply });
  localStorage.setItem("chatMemory", JSON.stringify(longTermMemory));

  // Vider la zone de texte et scroll
  document.getElementById("message").value = "";
  iaDiv.scrollIntoView({ behavior: "smooth" });
});
</script>

</body>
</html>
